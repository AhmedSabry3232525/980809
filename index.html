<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>File Manager - Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    ul { list-style: none; padding-left: 1em; }
    .folder { font-weight: bold; cursor: pointer; color: #1976d2; }
    .folder:hover { text-decoration: underline; }
    .file { margin-left: 1em; }
    .actions { margin-left: 1em; }
    button { margin-left: 0.2em; }
    .breadcrumbs { margin-bottom: 1em; }
    .breadcrumbs span { cursor: pointer; color: #1976d2; }
    .breadcrumbs span:hover { text-decoration: underline; }
    .breadcrumbs .sep { color: #888; }
  </style>
</head>
<body>
  <h1>File Manager (Admin)</h1>
  <div style="margin-bottom:1em;">
    <a href="auth.html" style="color:#1976d2;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
  </div>
  <div class="breadcrumbs" id="breadcrumbs"></div>
  <div id="file-tree"></div>
  <div id="error-message" style="color:red"></div>
  <hr>
  <button onclick="createFolder(currentFolder)">+ Ù…Ø¬Ù„Ø¯ Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§</button>
  <button onclick="createFile(currentFolder)">+ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§</button>
  <script>
    // ...Supabase config...
    const supabaseUrl = 'https://ixotpdhfnnnpeikgmwrm.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4b3RwZGhmbm5ucGVpa2dtd3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4NDc1OTIsImV4cCI6MjA2MzQyMzU5Mn0.S3W7B1EcNCTlIfWL82aboEFkMG3WkJK1T0Cy8HC0hIs';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let filesCache = [];
    let currentFolder = null; // null = root

    function getFolderPath(folderId) {
      const path = [];
      let fid = folderId;
      while (fid) {
        const folder = filesCache.find(f => f.id === fid);
        if (!folder) break;
        path.unshift({ id: folder.id, name: folder.name });
        fid = folder.parent_id;
      }
      return path;
    }

    function renderBreadcrumbs() {
      const path = getFolderPath(currentFolder);
      let html = `<span onclick="navigateTo(null)">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;
      path.forEach((item, idx) => {
        html += `<span class="sep"> / </span><span onclick="navigateTo('${item.id}')">${item.name}</span>`;
      });
      document.getElementById('breadcrumbs').innerHTML = html;
    }

    function buildTree(files, parentId) {
      const nodes = files.filter(f => f.parent_id === parentId);
      if (!nodes.length) return '<i>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</i>';
      let html = '<ul>';
      for (const node of nodes) {
        if (node.type === 'folder') {
          html += `<li>
            <span class="folder" onclick="navigateTo('${node.id}')">ğŸ“ ${node.name}</span>
            <span class="actions">
              <button onclick="event.stopPropagation();createFolder('${node.id}')">+Ù…Ø¬Ù„Ø¯</button>
              <button onclick="event.stopPropagation();createFile('${node.id}')">+Ù…Ù„Ù</button>
              <button onclick="event.stopPropagation();renameNode('${node.id}')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
              <button onclick="event.stopPropagation();deleteNode('${node.id}')">Ø­Ø°Ù</button>
              <button onclick="event.stopPropagation();moveNode('${node.id}')">Ù†Ù‚Ù„</button>
              <button onclick="event.stopPropagation();embedYoutube('${node.id}')">ØªØ¶Ù…ÙŠÙ† ÙÙŠØ¯ÙŠÙˆ</button>
            </span>
            ${node.youtube_url ? `<div style="margin:0.5em 0 0 2em;font-size:0.95em;color:#1976d2;">ğŸ¬ <a href="${node.youtube_url}" target="_blank">Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨</a></div>` : ''}
          </li>`;
        } else {
          html += `<li class="file">
            ğŸ“„ ${node.name}
            <span class="actions">
              <button onclick="renameNode('${node.id}')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</button>
              <button onclick="deleteNode('${node.id}')">Ø­Ø°Ù</button>
              <button onclick="moveNode('${node.id}')">Ù†Ù‚Ù„</button>
            </span>
          </li>`;
        }
      }
      html += '</ul>';
      return html;
    }

    function navigateTo(folderId) {
      currentFolder = folderId;
      renderTree();
    }

    async function fetchFiles() {
      try {
        const { data, error } = await supabase
          .from('files')
          .select('*');
        if (error) {
          document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message;
          return [];
        }
        document.getElementById('error-message').innerText = '';
        filesCache = data;
        return data;
      } catch (e) {
        document.getElementById('error-message').innerText = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: ' + e.message;
        return [];
      }
    }

    function extractYoutubeId(url) {
      // Supports: https://youtu.be/ID, https://www.youtube.com/watch?v=ID, etc.
      if (!url) return null;
      let match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/))([A-Za-z0-9_-]{11})/);
      if (match) return match[1];
      // fallback for v= param
      let v = (url.split('v=')[1] || '').substring(0, 11);
      return v || null;
    }

    async function renderTree() {
      filesCache = await fetchFiles();
      renderBreadcrumbs();
      const files = filesCache;
      let content = '';
      // Show YouTube video if current folder has one
      if (currentFolder) {
        const folder = filesCache.find(f => f.id === currentFolder && f.type === 'folder');
        if (folder && folder.youtube_url) {
          const vid = extractYoutubeId(folder.youtube_url);
          if (vid) {
            content += `<div style="margin-bottom:1em;">
              <iframe width="420" height="236" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>
            </div>`;
          }
        }
      }
      content += buildTree(files, currentFolder);
      document.getElementById('file-tree').innerHTML = content;
      if (!files.length) {
        document.getElementById('file-tree').innerHTML = '<i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</i>';
      }
    }

    async function createFolder(parentId) {
      const name = prompt('Folder name?');
      if (!name) return;
      const youtube_url = prompt('YouTube video link (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):');
      const insertObj = { name, type: 'folder', parent_id: parentId };
      if (youtube_url) insertObj.youtube_url = youtube_url;
      const { error } = await supabase.from('files').insert([insertObj]);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯: ' + error.message;
      } else {
        renderTree();
      }
    }

    async function createFile(parentId) {
      const name = prompt('File name?');
      if (!name) return;
      const { error } = await supabase.from('files').insert([{ name, type: 'file', parent_id: parentId }]);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù: ' + error.message;
      } else {
        renderTree();
      }
    }

    async function renameNode(id) {
      const node = filesCache.find(f => f.id === id);
      if (!node) return;
      const name = prompt('New name?', node.name);
      if (!name) return;
      let updateObj = { name };
      if (node.type === 'folder') {
        // allow editing youtube_url on rename for folders
        const youtube_url = prompt('YouTube video link (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):', node.youtube_url || '');
        updateObj.youtube_url = youtube_url || null;
      }
      const { error } = await supabase.from('files').update(updateObj).eq('id', id);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©: ' + error.message;
      } else {
        renderTree();
      }
    }

    async function deleteNode(id) {
      if (!confirm('Delete this item and all its children?')) return;
      const toDelete = [id];
      function collectChildren(pid) {
        filesCache.filter(f => f.parent_id === pid).forEach(child => {
          toDelete.push(child.id);
          if (child.type === 'folder') collectChildren(child.id);
        });
      }
      collectChildren(id);
      const { error } = await supabase.from('files').delete().in('id', toDelete);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message;
      } else {
        renderTree();
      }
    }

    async function moveNode(id) {
      const node = filesCache.find(f => f.id === id);
      if (!node) return;
      const dest = prompt('Enter destination folder id (empty for root):');
      if (dest === null) return;
      if (dest && !filesCache.find(f => f.id === dest && f.type === 'folder')) {
        alert('Invalid folder id');
        return;
      }
      const { error } = await supabase.from('files').update({ parent_id: dest || null }).eq('id', id);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ù‚Ù„: ' + error.message;
      } else {
        renderTree();
      }
    }

    async function embedYoutube(id) {
      const node = filesCache.find(f => f.id === id);
      if (!node || node.type !== 'folder') return;
      const youtube_url = prompt('YouTube video link:', node.youtube_url || '');
      if (youtube_url === null) return;
      const { error } = await supabase.from('files').update({ youtube_url: youtube_url || null }).eq('id', id);
      if (error) {
        document.getElementById('error-message').innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: ' + error.message;
      } else {
        renderTree();
      }
    }

    window.navigateTo = navigateTo;
    window.createFolder = createFolder;
    window.createFile = createFile;
    window.renameNode = renameNode;
    window.deleteNode = deleteNode;
    window.moveNode = moveNode;
    window.embedYoutube = embedYoutube;

    renderTree();

    // Real-time updates
    supabase
      .channel('public:files')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'files' }, payload => {
        renderTree();
      })
      .subscribe();
  </script>
</body>
</html>
